
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../usage/">
      
      
        <link rel="next" href="../automate/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.4.2">
    
    
      
        <title>Installation - S.O. Conda</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.d451bc0e.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#creating-a-simons-observatory-environment" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="S.O. Conda" class="md-header__button md-logo" aria-label="S.O. Conda" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            S.O. Conda
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Installation
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="S.O. Conda" class="md-nav__button md-logo" aria-label="S.O. Conda" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    S.O. Conda
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../usage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Use and Customization
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Installation
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#base-conda-environment" class="md-nav__link">
    Base Conda Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-note-on-mpi4py" class="md-nav__link">
    Special Note on mpi4py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-local-system" class="md-nav__link">
    Example:  Local System
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-nersc" class="md-nav__link">
    Example:  NERSC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    Running Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-a-jupyter-kernel" class="md-nav__link">
    Installing a Jupyter Kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customizing-an-environment" class="md-nav__link">
    Customizing an Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deleting-an-environment" class="md-nav__link">
    Deleting an Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-details" class="md-nav__link">
    Advanced Details
  </a>
  
    <nav class="md-nav" aria-label="Advanced Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pixell" class="md-nav__link">
    Pixell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libactpol-moby2" class="md-nav__link">
    Libactpol / Moby2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#so3g" class="md-nav__link">
    So3g
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toast" class="md-nav__link">
    TOAST
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../automate/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Automated Deployment
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../dev/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Developer Notes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/simonsobs/soconda" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Source on GitHub
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#base-conda-environment" class="md-nav__link">
    Base Conda Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#special-note-on-mpi4py" class="md-nav__link">
    Special Note on mpi4py
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-local-system" class="md-nav__link">
    Example:  Local System
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-nersc" class="md-nav__link">
    Example:  NERSC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#running-tests" class="md-nav__link">
    Running Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing-a-jupyter-kernel" class="md-nav__link">
    Installing a Jupyter Kernel
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customizing-an-environment" class="md-nav__link">
    Customizing an Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deleting-an-environment" class="md-nav__link">
    Deleting an Environment
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-details" class="md-nav__link">
    Advanced Details
  </a>
  
    <nav class="md-nav" aria-label="Advanced Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pixell" class="md-nav__link">
    Pixell
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#libactpol-moby2" class="md-nav__link">
    Libactpol / Moby2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#so3g" class="md-nav__link">
    So3g
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toast" class="md-nav__link">
    TOAST
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="creating-a-simons-observatory-environment">Creating a Simons Observatory Environment</h1>
<p>The install script takes options to specify the location of the base environment
(if it is not already activated) and the name (or full path) of the environment
to create. It also allows specifying a central location to install the
modulefile:</p>
<pre><code>$&gt; ./soconda.sh -h
    Usage:  ./soconda.sh
    [-e &lt;environment, either name or full path&gt;]
    [-b &lt;conda base install (if not activated)&gt;]
    [-v &lt;version (git version used by default)&gt;]
    [-m &lt;modulefile dir (default is &lt;env&gt;/modulefiles)&gt;]
    [-i &lt;file with modulefile commands to load dependencies&gt; ]
</code></pre>
<hr />
<p><strong>NOTE</strong></p>
<p>Running the <code>soconda.sh</code> script will create log files in the current directory.
Consider running the command from within a temporary build directory to avoid
clutter.</p>
<hr />
<h2 id="base-conda-environment">Base Conda Environment</h2>
<p>If you already have a conda-forge base environment, then you can skip this
step. However, you should consider setting the "solver" in the base environment
to use libmamba. This will greatly speed up the dependency resolution
calculation. Once you decide on the install prefix for your overall conda
environment you can use the included bootstrap script. For this example, we
will use <code>/opt/conda</code> as the path to the conda base installation. Now run the
bootstrap script:</p>
<pre><code>$&gt; ./tools/bootstrap_base "/opt/conda"
</code></pre>
<p>This bootstrap will install a base system with the conda-forge channel set to
the default and using the libmamba solver. You can now source the conda
initialization file and activate this base environment:</p>
<pre><code>$&gt; source /opt/conda/etc/profile.d/conda.sh
$&gt; conda activate base
</code></pre>
<p>After installing an <code>soconda</code> environment below, you will not need this step
since it is done by the generated modulefile.</p>
<h2 id="special-note-on-mpi4py">Special Note on mpi4py</h2>
<p>By default, the conda package for mpi4py will be installed. This should work
well for stand-alone workstations or single nodes. If you have a cluster with a
customized MPI compiler, then set the <code>MPICC</code> environment variable to the MPI C
compiler before running <code>soconda.sh</code>. That will cause the mpi4py package to
be built using your system MPI compiler.</p>
<h2 id="example-local-system">Example:  Local System</h2>
<p>Starting from scratch, bootstrap a small conda-forge base environment in <code>~/conda</code>:</p>
<pre><code>$&gt; ./tools/bootstrap_base.sh ~/conda
$&gt; source ~/conda/etc/profile.d/conda.sh
$&gt; conda activate base
</code></pre>
<p>Create an <code>soconda</code> environment with default name and version. However, we
decide to put all the modulefiles into a central location in the root of the
base conda install:</p>
<pre><code>$&gt; ./soconda.sh -b ~/conda -m ~/conda/modulefiles
</code></pre>
<p>Now we can load the module:</p>
<pre><code>$&gt; module use ~/conda/modulefiles
$&gt; module avail
$&gt; module load soconda/XXXXXX
</code></pre>
<h2 id="example-nersc">Example:  NERSC</h2>
<p>At NERSC, the default provided python is from Anaconda, and does not work well
for our needs. Instead, we have a conda-forge base system installed in our
project software directory:</p>
<pre><code>$&gt; source /global/common/software/sobs/perlmutter/conda/etc/profile.d/conda.sh
$&gt; conda activate base
</code></pre>
<p>Now we can either install a shared software environment or use this base
environment to build a conda environment in a personal directory. If you are
installing to a shared software environment, you should do that as the project
account and follow a specific naming convention which is beyond the scope of
this document. If you wanted to install these tools to your home directory you
could do:</p>
<pre><code>$&gt; mkdir -p ~/conda_envs
$&gt; ./soconda.sh -e ~/conda_envs/soconda -m ~/conda_envs/modulefiles
</code></pre>
<p>And then load the module:</p>
<pre><code>$&gt; module use ~/conda_envs/modulefiles
$&gt; module avail
$&gt; module load soconda/XXXXXX
</code></pre>
<h2 id="running-tests">Running Tests</h2>
<p>After loading an <code>soconda</code> environment, you can run some tests with:</p>
<pre><code>$&gt; ./run_tests.sh
</code></pre>
<h2 id="installing-a-jupyter-kernel">Installing a Jupyter Kernel</h2>
<p>After loading an soconda module the first time, you can run (once) the included script:</p>
<pre><code>$&gt; soconda_jupyter.sh
</code></pre>
<p>This will install a kernel file so that jupyter knows how to launch a kernel
using this python stack.</p>
<h2 id="customizing-an-environment">Customizing an Environment</h2>
<p>If you want to dramatically change the package versions / content of an
<code>soconda</code> stack, just load the existing <code>base</code> conda environment and edit the
three lists of packages (<code>packages_[conda|pip|local].txt</code>) to exclude certain
packages or add extras. Then install it as usual.</p>
<h2 id="deleting-an-environment">Deleting an Environment</h2>
<p>The <code>soconda</code> environments are self contained and you can delete them by
removing the path or (if using a name), removing the <code>&lt;base dir&gt;/envs/&lt;name of
env&gt;</code> directory. You can optionally delete the modulefile and the pip local
directory in your home directory.</p>
<h2 id="advanced-details">Advanced Details</h2>
<p>The compiled packages assume the use of the conda compilers for consistency with
the libraries installed through conda. If you want to change those compilers you
can remove the <code>compilers</code> conda package and manually set the <code>CC</code>, <code>CXX</code>, and <code>FC</code>
environment variables. Full warning that this may cause problems with threading
interfaces, thread pinning, etc, when building packages that use OpenMP.</p>
<h3 id="pixell">Pixell</h3>
<p>We currently build pixell from source with the conda compilers for consistency,
rather than installing the wheel.</p>
<h3 id="libactpol-moby2">Libactpol / Moby2</h3>
<p>There are three conda recipes for <code>libactpol_deps</code>, <code>libactpol</code>, and <code>moby2</code>.
These are using git hashes that are either the latest or a branch / version
recommended for S.O. use.</p>
<h3 id="so3g">So3g</h3>
<p>This package is currently installed from the wheel, but the conda package is
being tested (using boost from conda-forge).</p>
<h3 id="toast">TOAST</h3>
<p>This package is currently built from source by default, with dependencies
installed through conda. When toast-3.0 arrives in the conda-forge toast
feedstock, it should be added back to <code>packages_conda.txt</code>. It should also work
to install the python wheel package by commenting out the toast entry in
<code>packages_local.txt</code> and adding it to <code>packages_pip.txt</code>.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.expand", "navigation.path"], "search": "../assets/javascripts/workers/search.a264c092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.726fbb30.min.js"></script>
      
    
  </body>
</html>